"use strict";(()=>{function S(){let r=localStorage.getItem("mims_user_id");if(r)return r;let a="u_"+Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15);return localStorage.setItem("mims_user_id",a),a}var C=function(){let r={serverUrl:"",userId:"",platform:"web",country:""},a=new Map,l=new Map,d=new Map,c=new Map;function m(e){r={...r,...e,userId:e.userId||S()},r.country||h()}function h(){let e=Intl.DateTimeFormat().resolvedOptions().timeZone,t={"Asia/Singapore":"sg","Asia/Kuala_Lumpur":"my","Asia/Manila":"ph","Asia/Jakarta":"id","Asia/Bangkok":"th","Asia/Ho_Chi_Minh":"vn"};r.country=t[e]||"unknown"}function p(e,t){a.set(e,{...t,elementId:t.elementId||e})}function w(e,t){l.set(e,t)}function v(){l.clear()}async function g(){if(!r.serverUrl){console.error("MIMSAds: Server URL not configured. Call MIMSAds.init() first.");return}if(a.size===0){console.warn("MIMSAds: No slots defined. Call MIMSAds.defineSlot() first.");return}try{let e=Array.from(a.entries()).map(([s,o])=>({id:s,width:o.width,height:o.height,ad_unit:o.adUnit||""})),t={};l.forEach((s,o)=>{t[o]=s});let n=await fetch(`${r.serverUrl}/v1/ads`,{method:"POST",headers:{"Content-Type":"application/json","X-User-ID":r.userId||""},body:JSON.stringify({slots:e,targeting:t,user_id:r.userId,platform:r.platform,country:r.country})});if(!n.ok)throw new Error(`HTTP ${n.status}`);let i=await n.json();if(i.ads&&Array.isArray(i.ads))for(let s of i.ads)y(s)}catch(e){console.error("MIMSAds: Failed to fetch ads",e)}}function y(e){let t=a.get(e.slot_id);if(!t)return;let n=document.getElementById(t.elementId||e.slot_id);if(!n){console.warn(`MIMSAds: Container element not found for slot ${e.slot_id}`);return}d.set(e.slot_id,e);let i=document.createElement("div");i.id=`mims-ad-${e.slot_id}`,i.style.cssText=`
      width: ${e.width}px;
      height: ${e.height}px;
      position: relative;
      overflow: hidden;
    `;let s=document.createElement("a");s.href=e.tracking.click,s.target="_blank",s.rel="noopener noreferrer",s.style.display="block";let o=document.createElement("img");o.src=e.image_url,o.alt="Advertisement",o.style.cssText=`
      width: ${e.width}px;
      height: ${e.height}px;
      display: block;
      border: none;
    `,s.appendChild(o),i.appendChild(s),n.innerHTML="",n.appendChild(i),u(e.tracking.impression),M(e,i)}function u(e){let t=new Image(1,1);t.src=e}function M(e,t){let n=null,i=!1,s=new IntersectionObserver(o=>{for(let _ of o)_.intersectionRatio>=.5?!n&&!i&&(n=window.setTimeout(()=>{i||(i=!0,u(e.tracking.viewable))},1e3)):n&&(clearTimeout(n),n=null)},{threshold:[0,.5,1]});s.observe(t),c.set(e.slot_id,s)}function f(){c.forEach(e=>{e.disconnect()}),c.clear(),d.forEach((e,t)=>{let n=a.get(t);if(n){let i=document.getElementById(n.elementId||t);i&&(i.innerHTML="")}}),d.clear()}async function I(){f(),await g()}function b(){return{...r}}function A(){return r.userId||""}return{init:m,defineSlot:p,setTargeting:w,clearTargeting:v,display:g,refresh:I,destroyAll:f,getConfig:b,getUserId:A}}();window.MIMSAds=C;})();
